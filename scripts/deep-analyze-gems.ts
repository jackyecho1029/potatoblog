
import { google } from 'googleapis';
import * as dotenv from 'dotenv';
import * as fs from 'fs';
import * as path from 'path';
import { YoutubeTranscript } from 'youtube-transcript';
import { GoogleGenerativeAI } from '@google/generative-ai';

// Load environment variables
dotenv.config({ path: '.env.local' });

const youtube = google.youtube('v3');
const YOUTUBE_API_KEY = process.env.YOUTUBE_API_KEY;
const GEMINI_API_KEY = process.env.gemini_api_key;

const genAI = new GoogleGenerativeAI(GEMINI_API_KEY || '');

async function analyzeVideo(videoId: string) {
    console.log(`\nğŸ” Analyzing video ID: ${videoId}...`);

    try {
        const videoResponse = await youtube.videos.list({
            key: YOUTUBE_API_KEY,
            part: ['snippet', 'statistics'],
            id: [videoId]
        });

        const video = videoResponse.data.items?.[0];
        if (!video) return null;

        const title = video.snippet?.title || '';
        const description = video.snippet?.description || '';
        const views = parseInt(video.statistics?.viewCount || '0').toLocaleString();
        const url = `https://www.youtube.com/watch?v=${videoId}`;

        let transcript = '';
        try {
            const transcriptItems = await YoutubeTranscript.fetchTranscript(videoId);
            transcript = transcriptItems.map(item => item.text).join(' ').substring(0, 10000);
        } catch (e) {
            console.log(`   (No transcript available for ${videoId}, using description)`);
            transcript = description;
        }

        const model = genAI.getGenerativeModel({ model: "gemini-3-flash-preview" });

        const prompt = `
ä½ æ˜¯ä¸€ä½é¡¶çº§çš„ YouTube çˆ†æ¬¾å†…å®¹æ‹†è§£ä¸“å®¶å’Œè¥é”€ç­–ç•¥å¸ˆã€‚
æˆ‘ä»¬å°†ç ”ç©¶ä¸€ä¸ªâ€œä½ç²‰çˆ†æ¬¾â€è§†é¢‘ï¼ˆç²‰ä¸æå°‘ä½†æ’­æ”¾é‡æƒŠäººï¼‰ã€‚

**è§†é¢‘æ ‡é¢˜:** ${title}
**æ’­æ”¾é‡:** ${views}
**å†…å®¹ç‰‡æ®µ/è½¬å½•:** ${transcript}

è¯·æ ¹æ®ä½ çš„ä¸“ä¸šçŸ¥è¯†ï¼Œç»™å‡ºä»¥ä¸‹æ·±åº¦çš„æ‹†è§£ï¼š

1. **çˆ†ç«åŸå›  (The Why):** ä¸ºä»€ä¹ˆå…³æ³¨äººæ•°å°‘ä¸”æ’­æ”¾é‡å´èƒ½è¾¾åˆ°æƒŠäººé«˜åº¦ï¼Ÿ
2. **å†…å®¹ä¼˜åŠ¿ (Content Edge):** è¿™ä¸ªè§†é¢‘ç›¸æ¯”åŒç±»å‹çš„è§†é¢‘ï¼Œèµ¢åœ¨å“ªé‡Œï¼Ÿ
3. **ç»“æ„æ¡†æ¶ (Framework):** è§†é¢‘çš„å‰10ç§’ã€ä¸­é—´å’Œç»“å°¾æ˜¯å¦‚ä½•è®¾è®¡çš„ï¼Ÿ
4. **å—ä¼—ä¸éœ€æ±‚ (Audience & Needs):** å®ƒçš„ç›®æ ‡å—ä¼—æ˜¯è°ï¼Ÿæ»¡è¶³äº†ä»€ä¹ˆéœ€æ±‚ï¼Ÿ
5. **æ ¸å¿ƒè§‚ç‚¹ (Core Insights):** è§†é¢‘ä¼ é€’çš„æœ€æ ¸å¿ƒè§‚ç‚¹æ˜¯ä»€ä¹ˆï¼Ÿ
6. **å€Ÿé•œä¸å‚è€ƒ (Benchmarks):** æˆ‘ä»¬å¯ä»¥å­¦ä¹ çš„3ä¸ªå…·ä½“æˆ˜æœ¯ï¼Ÿ

è¯·ç”¨ä¸­æ–‡å›ç­”ï¼Œæ’ç‰ˆæ¸…æ™°ç¾è§‚ã€‚åœ¨å›ç­”çš„å¼€å¤´ï¼Œè¯·åŒ…å«åŸè§†é¢‘é“¾æ¥ï¼š${url}
`;

        const result = await model.generateContent(prompt);
        return result.response.text();

    } catch (error) {
        console.error(`Error analyzing ${videoId}:`, error);
        return null;
    }
}

async function run() {
    const topIdsFile = path.join(process.cwd(), 'reports/gems/top-ids.json');
    let videoIds = [];

    if (fs.existsSync(topIdsFile)) {
        videoIds = JSON.parse(fs.readFileSync(topIdsFile, 'utf8'));
        console.log(`âœ… Loaded ${videoIds.length} IDs from top-ids.json`);
    } else {
        console.error('âŒ top-ids.json not found. Run find-hidden-gems first.');
        process.exit(1);
    }

    const results = [];
    for (const id of videoIds) {
        const analysis = await analyzeVideo(id);
        if (analysis) results.push(analysis);
    }

    const date = new Date().toISOString().split('T')[0];

    // 1. Save as internal report
    const reportPath = path.join(process.cwd(), 'reports/gems/deep-analysis.md');
    fs.writeFileSync(reportPath, `# ğŸ§¬ YouTube ä½ç²‰çˆ†æ¬¾æ·±åº¦æ‹†è§£æŠ¥å‘Š (${date})\n\n` + results.join('\n\n---\n\n'));

    // 2. Save as Blog Post
    const blogPostPath = path.join(process.cwd(), `posts/${date}-youtube-hidden-gems-analysis.md`);
    const blogContent = `---
title: "ğŸ§¬ YouTube ä½ç²‰çˆ†æ¬¾æ·±åº¦æ‹†è§£ (${date})"
author: "Antigravity Analysis Bot"
category: "æ€ç»´æˆé•¿"
date: "${date}"
tags: ["YouTube", "çˆ†æ¬¾æ‹†è§£", "æµé‡å¢é•¿", "è‡ªåŠ¨æŒ–æ˜"]
---

# YouTube æ½œåŠ›çˆ†æ¬¾æ·±åº¦åˆ†ææŠ¥å‘Š

è¿™æ˜¯ç”± **Antigravity Gem Hunter** è‡ªåŠ¨æŒ–æ˜å¹¶ç”Ÿæˆçš„æ·±åº¦å†…å®¹åˆ†æã€‚

` + results.join('\n\n---\n\n') + `

---
*Generated by PotatoAnalytics Hub Automation*
`;

    fs.writeFileSync(blogPostPath, blogContent);
    console.log(`\nâœ… Blog post generated: ${blogPostPath}`);
}

run();
